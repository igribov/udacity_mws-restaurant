"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,a=!1,o=void 0;try{for(var i,u=e[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{!r&&u.return&&u.return()}finally{if(a)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function o(i,u,c){function s(t,e){if(!u[t]){if(!i[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(l)return l(t,!0);var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}var a=u[t]={exports:{}};i[t][0].call(a.exports,function(e){return s(i[t][1][e]||e)},a,a.exports,o,i,u,c)}return u[t].exports}for(var l="function"==typeof require&&require,e=0;e<c.length;e++)s(c[e]);return s}({1:[function(e,h,t){!function(){function i(n){return new Promise(function(e,t){n.onsuccess=function(){e(n.result)},n.onerror=function(){t(n.error)}})}function o(n,r,a){var o,e=new Promise(function(e,t){i(o=n[r].apply(n,a)).then(e,t)});return e.request=o,e}function e(e,n,t){t.forEach(function(t){Object.defineProperty(e.prototype,t,{get:function(){return this[n][t]},set:function(e){this[n][t]=e}})})}function t(t,n,r,e){e.forEach(function(e){e in r.prototype&&(t.prototype[e]=function(){return o(this[n],e,arguments)})})}function n(t,n,r,e){e.forEach(function(e){e in r.prototype&&(t.prototype[e]=function(){return this[n][e].apply(this[n],arguments)})})}function r(e,r,t,n){n.forEach(function(n){n in t.prototype&&(e.prototype[n]=function(){return e=this[r],(t=o(e,n,arguments)).then(function(e){if(e)return new u(e,t.request)});var e,t})})}function a(e){this._index=e}function u(e,t){this._cursor=e,this._request=t}function c(e){this._store=e}function s(n){this._tx=n,this.complete=new Promise(function(e,t){n.oncomplete=function(){e()},n.onerror=function(){t(n.error)},n.onabort=function(){t(n.error)}})}function l(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new s(n)}function f(e){this._db=e}e(a,"_index",["name","keyPath","multiEntry","unique"]),t(a,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),r(a,"_index",IDBIndex,["openCursor","openKeyCursor"]),e(u,"_cursor",["direction","key","primaryKey","value"]),t(u,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(n){n in IDBCursor.prototype&&(u.prototype[n]=function(){var t=this,e=arguments;return Promise.resolve().then(function(){return t._cursor[n].apply(t._cursor,e),i(t._request).then(function(e){if(e)return new u(e,t._request)})})})}),c.prototype.createIndex=function(){return new a(this._store.createIndex.apply(this._store,arguments))},c.prototype.index=function(){return new a(this._store.index.apply(this._store,arguments))},e(c,"_store",["name","keyPath","indexNames","autoIncrement"]),t(c,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),r(c,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),n(c,"_store",IDBObjectStore,["deleteIndex"]),s.prototype.objectStore=function(){return new c(this._tx.objectStore.apply(this._tx,arguments))},e(s,"_tx",["objectStoreNames","mode"]),n(s,"_tx",IDBTransaction,["abort"]),l.prototype.createObjectStore=function(){return new c(this._db.createObjectStore.apply(this._db,arguments))},e(l,"_db",["name","version","objectStoreNames"]),n(l,"_db",IDBDatabase,["deleteObjectStore","close"]),f.prototype.transaction=function(){return new s(this._db.transaction.apply(this._db,arguments))},e(f,"_db",["name","version","objectStoreNames"]),n(f,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(o){[c,a].forEach(function(e){o in e.prototype&&(e.prototype[o.replace("open","iterate")]=function(){var e,t=(e=arguments,Array.prototype.slice.call(e)),n=t[t.length-1],r=this._store||this._index,a=r[o].apply(r,t.slice(0,-1));a.onsuccess=function(){n(a.result)}})})}),[a,c].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,n){var r=this,a=[];return new Promise(function(t){r.iterateCursor(e,function(e){e?(a.push(e.value),void 0===n||a.length!=n?e.continue():t(a)):t(a)})})})});var d={open:function(e,t,n){var r=o(indexedDB,"open",[e,t]),a=r.request;return a.onupgradeneeded=function(e){n&&n(new l(a.result,e.oldVersion,a.transaction))},r.then(function(e){return new f(e)})},delete:function(e){return o(indexedDB,"deleteDatabase",[e])}};void 0!==h?(h.exports=d,h.exports.default=h.exports):self.idb=d}()},{}],2:[function(e,t,n){var r=e("idb"),a="restaurants",o=function(){function o(){_classCallCheck(this,o)}return _createClass(o,null,[{key:"fetchRestaurants",value:function(){var t=this;return fetch(o.DATABASE_URL+"/restaurants").then(function(e){return e.json()}).then(function(e){return t.putRestaurantsIntoIndexedDb(e).then(function(){return e})}).catch(function(e){return o.fetchRestaurantsFromIndexedDb().then(function(e){if(e.length)return e;throw new Error("Fetch error")})})}},{key:"fetchRestaurantWithReviews",value:function(t){var a=this;return Promise.all([this.fetchRestaurant(t),this.fetchRestaurantReviews(t)]).then(function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1];return n.reviews=r,a.putRestaurantIntoIndexedDb(n).then(function(){return n})}).catch(function(e){return o.fetchRestaurantFromIndexedDb(t).then(function(e){if(e)return e;throw new Error("Fetch error")})})}},{key:"fetchRestaurant",value:function(e){return fetch(o.DATABASE_URL+"/restaurants/"+e).then(function(e){return e.json()})}},{key:"fetchRestaurantReviews",value:function(e){return fetch(o.DATABASE_URL+"/reviews/?restaurant_id="+e).then(function(e){return e.json()})}},{key:"fetchRestaurantsFromIndexedDb",value:function(){return o.openDatabase().then(function(e){return e.transaction(a).objectStore(a).getAll()})}},{key:"fetchRestaurantFromIndexedDb",value:function(t){return o.openDatabase().then(function(e){return e.transaction(a).objectStore(a).get(+t)})}},{key:"putRestaurantsIntoIndexedDb",value:function(n){return o.clearRestaurantsInIndexedDb().then(function(){return o.openDatabase().then(function(e){var t=e.transaction(a,"readwrite");return n.forEach(function(e){return t.objectStore(a).put(e)}),t.complete})})}},{key:"putRestaurantIntoIndexedDb",value:function(n){return o.openDatabase().then(function(e){var t=e.transaction(a,"readwrite");return t.objectStore(a).put(n),t.complete})}},{key:"clearRestaurantsInIndexedDb",value:function(){return o.openDatabase().then(function(e){var t=e.transaction(a,"readwrite");return t.objectStore(a).clear(),t.complete})}},{key:"openDatabase",value:function(){return r.open("restaurants-db",1,function(e){switch(e.oldVersion){case 0:e.createObjectStore(a,{keyPath:"id"}).createIndex("status","status")}})}},{key:"fetchRestaurantById",value:function(e){return o.fetchRestaurantWithReviews(e)}},{key:"fetchRestaurantByCuisine",value:function(t,e){o.fetchRestaurants().then(function(e){return e.filter(function(e){return e.cuisine_type==t})})}},{key:"fetchRestaurantByNeighborhood",value:function(t){return o.fetchRestaurants().then(function(e){return e.filter(function(e){return e.neighborhood==t})})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(n,r){return o.fetchRestaurants().then(function(e){var t=e;return"all"!=n&&(t=t.filter(function(e){return e.cuisine_type==n})),"all"!=r&&(t=t.filter(function(e){return e.neighborhood==r})),t})}},{key:"fetchNeighborhoodsAndCuisines",value:function(){return o.fetchRestaurants().then(function(n){var r=n.map(function(e,t){return n[t].neighborhood}),a=n.map(function(e,t){return n[t].cuisine_type});return{neighborhoods:r.filter(function(e,t){return r.indexOf(e)==t}),cuisines:a.filter(function(e,t){return a.indexOf(e)==t}),restaurants:n}})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return"/img/"+e.id+"_small.jpg"}},{key:"imageSrcSetForRestaurant",value:function(e){return"/img/"+e.photograph}},{key:"mapMarkerForRestaurant",value:function(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:o.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337"}}]),o}();t.exports=o},{idb:1}],3:[function(e,t,n){t.exports={registerServiceWorker:function(){}}},{}],4:[function(e,t,n){t.exports=function(e){var t=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(this.rating=document.querySelector(e),this.starList=[],this.rating){this.rating.setAttribute("aria-label",n.label),this.rating.setAttribute("tabindex","0"),this.rating.setAttribute("role","radiogroup"),this.rating.className="rating-select";for(var r=function(e){var r=document.createElement("div");r.className="rating-select__item",r.setAttribute("role","radio"),r.setAttribute("aria-checked",!1),r.setAttribute("tabindex",0),t.starList.push(r),r.addEventListener("click",function(e){var n=t.starList.indexOf(e.target);t.starList.map(function(e,t){e.classList.toggle("rating-select__item--checked",t<=n),t===n?(e.setAttribute("aria-checked",!0),r.setAttribute("tabindex",0)):(e.setAttribute("aria-checked",!1),r.setAttribute("tabindex",-1))})}),t.rating.append(r)},a=1;a<=n.max;a++)r()}}},{}],5:[function(e,t,n){var a=e("./dbhelper"),r=e("./process");new(e("./rating-select"))("#rating-select",{label:"Rating",max:5}),window.initMap=function(){r.registerServiceWorker(),function(){if(self.restaurant)return self.restaurant;var e=function(e,t){t||(t=window.location.href);e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);if(!n)return null;if(!n[2])return"";return decodeURIComponent(n[2].replace(/\+/g," "))}("id");{if(e)return a.fetchRestaurantById(e).then(function(e){if(!e)throw new Error("No restaurant");return e});throw new Error("No restaurant id in URL")}}().then(function(e){self.restaurant=e,function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant,t=document.getElementById("restaurant-name");t.innerHTML=e.name,t.setAttribute("tabindex","0"),document.getElementById("restaurant-address").innerHTML=e.address;var n=document.getElementById("restaurant-img");n.className="restaurant-img",n.setAttribute("alt","An image from the restaurant "+e.name),n.src=a.imageUrlForRestaurant(e);var r=document.getElementById("restaurant-cuisine");r.setAttribute("tabindex","0"),r.innerHTML=e.cuisine_type,e.operating_hours&&function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant.operating_hours,t=document.getElementById("restaurant-hours");for(var n in e){var r=document.createElement("tr"),a=document.createElement("td");a.innerHTML=n,r.appendChild(a);var o=document.createElement("td");o.innerHTML=e[n],o.setAttribute("aria-label",e[n]+","),r.appendChild(o),t.appendChild(r)}}();!function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant.reviews,t=document.getElementById("reviews-container");if(!e){var n=document.createElement("p");return n.innerHTML="No reviews yet!",t.appendChild(n)}var r=document.getElementById("reviews-list");e.forEach(function(e){r.appendChild(function(e){var t=document.createElement("li");t.setAttribute("tabindex","0"),t.className="reviews-list-item",t.setAttribute("aria-label","review");var n=document.createElement("div");n.className="reviewer-info";var r=document.createElement("div");r.className="reviewer-info__name-date";var a=document.createElement("h3");a.setAttribute("tabindex","0"),a.setAttribute("aria-label",e.name),a.innerHTML=e.name;var o=document.createElement("date");o.setAttribute("tabindex","0"),o.innerHTML=new Date(e.updatedAt).toDateString(),r.appendChild(a),r.appendChild(o),n.appendChild(r),n.appendChild(function(e){var t=document.createElement("p");t.appendChild((n=document.createElement("span"),n.className="rating-number",n.setAttribute("tabindex","0"),n.innerHTML="Rating : "+e,n));var n;var r="★".repeat(+e);+e<5&&(r+="☆".repeat(5-+e));var a=document.createElement("span");return a.className="rating-stars",a.innerHTML=r,t.appendChild(a),t}(e.rating)),t.appendChild(n);var i=document.createElement("p");return i.setAttribute("tabindex","0"),i.className="reviewer-comment",i.innerHTML=e.comments,t.appendChild(i),t}(e))}),t.appendChild(r)}()}(),self.map=new google.maps.Map(document.getElementById("map"),{zoom:16,center:e.latlng,scrollwheel:!1}),function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant,t=document.getElementById("breadcrumb"),n=document.createElement("li");n.innerHTML=e.name,t.appendChild(n)}(),a.mapMarkerForRestaurant(self.restaurant,self.map)}).catch(function(e){console.error(e)})}},{"./dbhelper":2,"./process":3,"./rating-select":4}]},{},[5]);
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJub2RlX21vZHVsZXMvaWRiL2xpYi9pZGIuanMiLCJzcmMvanMvZGJoZWxwZXIuanMiLCJzcmMvanMvcHJvY2Vzcy5qcyIsInNyYy9qcy9yYXRpbmctc2VsZWN0LmpzIiwic3JjL2pzL3Jlc3RhdXJhbnRfaW5mby5qcyJdLCJuYW1lcyI6WyJyZXN1bHQiLCJlcnJvciIsInJlcXVlc3QiLCJhcmdzIiwicmVqZWN0IiwicCIsInByb3AiLCJ2YWwiLCJhcmd1bWVudHMiLCJpbmRleCIsImN1cnNvciIsInN0b3JlIiwiaWRiVHJhbnNhY3Rpb24iLCJyZXNvbHZlIiwiZGIiLCJvbGRWZXJzaW9uIiwidHJhbnNhY3Rpb24iLCJ0aGlzIiwiX3JlcXVlc3QiLCJhcnIiLCJfaW5kZXgiLCJ2YWx1ZSIsImNvbnRpbnVlIiwiaXRlbXMiLCJ2ZXJzaW9uIiwibmFtZSIsImV4cCIsImV4cG9ydHMiLCJpZGIiLCJyZXF1aXJlIiwiREJfUkVTVEFVUkFOVFNfVEFCTEUiLCJEQkhlbHBlciIsIl90aGlzIiwiREFUQUJBU0VfVVJMIiwidGhlbiIsImRhdGEiLCJqc29uIiwicmVzdGF1cmFudHMiLCJwdXRSZXN0YXVyYW50c0ludG9JbmRleGVkRGIiLCJjYXRjaCIsImVyciIsImZldGNoUmVzdGF1cmFudHNGcm9tSW5kZXhlZERiIiwibGVuZ3RoIiwiRXJyb3IiLCJpZCIsIl90aGlzMiIsImFsbCIsImZldGNoUmVzdGF1cmFudCIsImZldGNoUmVzdGF1cmFudFJldmlld3MiLCJfcmVmIiwiX3JlZjIiLCJfc2xpY2VkVG9BcnJheSIsInJlc3RhdXJhbnQiLCJyZXZpZXdzIiwicHV0UmVzdGF1cmFudEludG9JbmRleGVkRGIiLCJmZXRjaFJlc3RhdXJhbnRGcm9tSW5kZXhlZERiIiwicmVzdGF1cmFudElkIiwib3BlbkRhdGFiYXNlIiwib2JqZWN0U3RvcmUiLCJnZXRBbGwiLCJnZXQiLCJjbGVhclJlc3RhdXJhbnRzSW5JbmRleGVkRGIiLCJ0eCIsImZvckVhY2giLCJwdXQiLCJjb21wbGV0ZSIsImNsZWFyIiwib3BlbiIsInVwZ3JhZGVEYiIsImNyZWF0ZU9iamVjdFN0b3JlIiwia2V5UGF0aCIsImNyZWF0ZUluZGV4IiwiZmV0Y2hSZXN0YXVyYW50V2l0aFJldmlld3MiLCJjdWlzaW5lIiwiY2FsbGJhY2siLCJmZXRjaFJlc3RhdXJhbnRzIiwiZmlsdGVyIiwiciIsImN1aXNpbmVfdHlwZSIsIm5laWdoYm9yaG9vZCIsInJlc3VsdHMiLCJuZWlnaGJvcmhvb2RzIiwibWFwIiwidiIsImkiLCJjdWlzaW5lcyIsImluZGV4T2YiLCJwaG90b2dyYXBoIiwiZ29vZ2xlIiwibWFwcyIsIk1hcmtlciIsImxhdGxuZyIsInVybEZvclJlc3RhdXJhbnQiLCJBbmltYXRpb24iLCJEUk9QIiwibW9kdWxlIiwicmVnaXN0ZXJTZXJ2aWNlV29ya2VyIiwic2VsZWN0b3IiLCJfdGhpczMiLCJvcHRpb25zIiwidW5kZWZpbmVkIiwicmF0aW5nIiwiZG9jdW1lbnQiLCJxdWVyeVNlbGVjdG9yIiwic3Rhckxpc3QiLCJzZXRBdHRyaWJ1dGUiLCJsYWJlbCIsImNsYXNzTmFtZSIsInN0YXIiLCJjcmVhdGVFbGVtZW50IiwicHVzaCIsImFkZEV2ZW50TGlzdGVuZXIiLCJlIiwiY2xpY2tlZFN0YXJJbmRleCIsInRhcmdldCIsImVsIiwiY2xhc3NMaXN0IiwidG9nZ2xlIiwiYXBwZW5kIiwibWF4IiwiX2xvb3AiLCJwcm9jZXNzIiwid2luZG93IiwiaW5pdE1hcCIsInNlbGYiLCJ1cmwiLCJsb2NhdGlvbiIsImhyZWYiLCJyZXBsYWNlIiwiUmVnRXhwIiwiZXhlYyIsImRlY29kZVVSSUNvbXBvbmVudCIsImdldFBhcmFtZXRlckJ5TmFtZSIsImZldGNoUmVzdGF1cmFudEJ5SWQiLCJnZXRFbGVtZW50QnlJZCIsImlubmVySFRNTCIsImFkZHJlc3MiLCJpbWFnZSIsInNyYyIsImltYWdlVXJsRm9yUmVzdGF1cmFudCIsIm9wZXJhdGluZ19ob3VycyIsIm9wZXJhdGluZ0hvdXJzIiwiaG91cnMiLCJrZXkiLCJyb3ciLCJkYXkiLCJhcHBlbmRDaGlsZCIsInRpbWUiLCJmaWxsUmVzdGF1cmFudEhvdXJzSFRNTCIsImNvbnRhaW5lciIsIm5vUmV2aWV3cyIsInVsIiwicmV2aWV3IiwibGkiLCJyZXZpZXdlckluZm9CbG9jayIsInJldmlld2VyTmFtZURhdGUiLCJkYXRlIiwiRGF0ZSIsInVwZGF0ZWRBdCIsInRvRGF0ZVN0cmluZyIsInJhdGluZ1ZhbHVlIiwic3BhbiIsInJhdGluZ1N0YXJzIiwicmVwZWF0IiwicmF0aW5nU3RhcnNFbGVtZW50IiwiY3JlYXRlUmF0aW5nU3RhcnNCbG9jayIsImNvbW1lbnRzIiwiY3JlYXRlUmV2aWV3SFRNTCIsImZpbGxSZXZpZXdzSFRNTCIsImZpbGxSZXN0YXVyYW50SFRNTCIsIk1hcCIsImJyZWFkY3J1bWIiLCJmaWxsQnJlYWRjcnVtYiIsIm1hcE1hcmtlckZvclJlc3RhdXJhbnQiXSwibWFwcGluZ3MiOiJvc0NBQUEsMkdDV0FBLGtDQUlBQyxnQ0FNQUMsK0NBRUFDLFdBQ0FDLHNCQUdBRixFQUNBRyw2R0FlQUMsK0JBR0FDLGlIQVVBQyxzSUFTQUEsZ0lBU0FBLG1EQXZDQU4saURBNkNBTywrQkF3QkFDLGdCQUNBUiw0QkFnQ0FTLHlCQXdDQUMsa0VBR0FDLDhCQUdBWixpQ0FHQUEscUNBbUJBYSxrQkFDQUMseUJBQ0FDLDBCQW1CQUYsZUEvSUEsQ0FDQSxPQUNBLFVBQ0EsYUFDQSxpQ0FHQSxDQUNBLE1BQ0EsU0FDQSxTQUNBLGFBQ0EsZ0NBR0EsQ0FDQSxhQUNBLGdDQVFBLENBQ0EsWUFDQSxNQUNBLGFBQ0Esa0NBR0EsQ0FDQSxTQUNBLHNJQU9BRyxPQUNBVCx1RkFFQUwsd0RBR0FlLDRHQVdBViwyRkFJQUEsMEJBR0EsQ0FDQSxPQUNBLFVBQ0EsYUFDQSw4Q0FHQSxDQUNBLE1BQ0EsTUFDQSxTQUNBLFFBQ0EsTUFDQSxTQUNBLFNBQ0EsYUFDQSxzQ0FHQSxDQUNBLGFBQ0EsOENBR0EsQ0FDQSxvR0FtQkFBLHVCQUdBLENBQ0EsbUJBQ0Esa0NBR0EsQ0FDQSwwR0FVQUEsdUJBR0EsQ0FDQSxPQUNBLFVBQ0EsMkNBR0EsQ0FDQSxvQkFDQSw4RkFRQUEsdUJBR0EsQ0FDQSxPQUNBLFVBQ0EsMkNBR0EsQ0FDQSx5S0FXQUEscUNBdFBBVyxpQkF1UEEsdUJBQ0FDLGlDQUNBLCtCQUVBcEIscUdBVUFpQixPQUNBLDRFQVFBSSxpQ0FNQUMsYUFIQUMsTUFOQUEsbUVBaUJBQyxRQUNBdEIsZ0ZBSUFjLCtDQUtBRiw4REFJQVcsNEJBS0FDLHNCQUNBQyxrQkFHQUQsNkJDeFRBLElBQU1FLEVBQU1DLEVBQVosT0FFTUMsRUFBTixjQU1BQyxFQUFBLHFIQWM0QixJQUFBQyxFQUFBZixrQkFDWGMsRUFBQUUsYUFBTixnQkFBQUMsS0FBQSxTQUFBQyxHQUNDLE9BQVFBLEVBRFRDLFNBQUFGLEtBRUMsU0FBQUcsWUFDR0MsNEJBQUFELEdBQUFILEtBQUEsV0FBbUQsT0FBMURHLE1BSEdFLE1BS0UsU0FBQUMsWUFDRUMsZ0NBQUFQLEtBQThDLFNBQUFHLE1BQzlDQSxFQUFMSyxjQUdFTCxRQUZNLElBQUFNLE1BQU4sc0VBV1ZDLEdBQXNDLElBQUFDLEVBQUE1QixvQkFDN0I2QixJQUFZLENBQ2pCN0IsS0FBQThCLGdCQURpQkgsR0FFakIzQixLQUFBK0IsdUJBRktKLEtBQUFWLEtBR0MsU0FBQWUsR0FBNkIsSUFBQUMsRUFBQUMsZUFBQUYsRUFBQSxHQUE1QkcsRUFBQUYsRUFBQSxHQUFERyxFQUFBSCxFQUFBLFlBQ05HLFFBQUFBLElBQ09DLDJCQUFBRixHQUFBbEIsS0FBQSxXQUFpRCxPQUF4RGtCLE1BTEtiLE1BTUUsU0FBQUMsWUFDQWUsNkJBQUFYLEdBQUFWLEtBQStDLFNBQUFrQixNQUNwREEsU0FHRUEsUUFGTSxJQUFBVCxNQUFOLDJEQVdSQyxnQkFDa0JiLEVBQVNFLGFBQUEsZ0JBQWxCVyxHQUFBVixLQUFBLFNBQUFDLEdBQ0MsT0FBUUEsRUFEaEJDLHdEQUlGb0IsZ0JBQ2tCekIsRUFBU0UsYUFBQSwyQkFBbEJ1QixHQUFBdEIsS0FBQSxTQUFBQyxHQUNDLE9BQVFBLEVBRGhCQywwRUFLT3FCLGVBQUF2QixLQUFBLFNBQUFwQixHQUNDLE9BQU1BLEVBQUFFLFlBQUFjLEdBQUE0QixZQUFBNUIsR0FEZDZCLGdFQUlGZixZQUNTYSxlQUFBdkIsS0FBQSxTQUFBcEIsR0FBNkIsT0FDbENBLEVBQUFFLFlBQUFjLEdBQUE0QixZQUFBNUIsR0FBQThCLEtBREZoQix5REFJRlAsWUFDU3dCLDhCQUFBM0IsS0FBQSxXQUE0QyxPQUFBSCxFQUFNMEIsZUFBQXZCLEtBQTZCLFNBQUFwQixPQUM1RWdELEVBQUtoRCxFQUFBRSxZQUFBYyxFQUFYLHNCQUNBaUMsUUFBQSxTQUFBWCxHQUFvQixPQUFjVSxFQUFBSixZQUFBNUIsR0FBQWtDLElBQWxDWixLQUNPVSxFQUFQRyxnRUFLTmIsWUFDU0ssZUFBQXZCLEtBQTZCLFNBQUFwQixPQUM1QmdELEVBQUtoRCxFQUFBRSxZQUFBYyxFQUFYLHNCQUNBNEIsWUFBQTVCLEdBQUFrQyxJQUFBWixHQUNPVSxFQUFQRywwRUFLS1IsZUFBQXZCLEtBQTZCLFNBQUFwQixPQUM1QmdELEVBQUtoRCxFQUFBRSxZQUFBYyxFQUFYLHNCQUNBNEIsWUFBQTVCLEdBQUFvQyxRQUNPSixFQUFQRywyREFLS0UsS0E1R1gsaUJBRUEsRUEwRzZDLFNBQUFDLFVBQy9CQSxFQUFSckQsaUJBQ0UsRUFDMEJxRCxFQUFBQyxrQkFBQXZDLEVBQWtELENBQUN3QyxRQUEzRSxPQUNBQyxZQUFBLFNBQUEseURBV1IzQixVQUVTYixFQUFBeUMsMkJBQVA1QixvREFNRjZCLEVBQUFDLEtBRUVDLG1CQUFBekMsS0FBaUMsU0FBQUcsWUFDeEJ1QyxPQUFBLFNBQUFDLEdBQW1CLE9BQUtBLEVBQUFDLGNBQS9CTCw0REFRSk0sWUFFU0osbUJBQUF6QyxLQUFpQyxTQUFBRyxZQUMvQnVDLE9BQUEsU0FBQUMsR0FBbUIsT0FBS0EsRUFBQUUsY0FBL0JBLHNFQU9KTixFQUFBTSxZQUVTSixtQkFBQXpDLEtBQWlDLFNBQUFHLE9BQ2xDMkMsRUFBSjNDLFFBRUEsT0FBSW9DLFFBQ1FHLE9BQUEsU0FBQUMsR0FBZSxPQUFLQSxFQUFBQyxjQUE5QkwsS0FFRixPQUFJTSxRQUNRSCxPQUFBLFNBQUFDLEdBQWUsT0FBS0EsRUFBQUUsY0FBOUJBLEtBRUZDLHFFQVNLTCxtQkFBQXpDLEtBQWlDLFNBQUFHLE9BQ2hDNEMsRUFBQTVDLEVBQWdCNkMsSUFBQSxTQUFnQkMsRUFBQUMsR0FBQSxPQUFVL0MsRUFBQStDLEdBQWhETCxlQUVNTSxFQUFBaEQsRUFBVzZDLElBQUEsU0FBZ0JDLEVBQUFDLEdBQUEsT0FBVS9DLEVBQUErQyxHQUEzQ04sc0NBSWlCRixPQUFBLFNBQXFCTyxFQUFBQyxHQUFBLE9BQVVILEVBQUFLLFFBQUFILElBRHpDQyxlQUVLUixPQUFBLFNBQWdCTyxFQUFBQyxHQUFBLE9BQVVDLEVBQUFDLFFBQUFILElBRi9CQyxJQUFQL0MsWUFBQUEsOENBV0plLEdBQ1csTUFBQSx3QkFBdUJBLEVBQWhDUixpREFNRlEsR0FDVSxNQUFBLFFBQU9BLEVBQWZSLEdBQUEsOERBTUZRLEdBQ1csTUFBQSxRQUFPQSxFQUFoQm1DLDBEQU1GbkMsRUFBQThCLFVBQ1EsSUFBYU0sT0FBQUMsS0FBSkMsT0FBQSxVQUNEdEMsRUFEd0J1QyxhQUUzQnZDLEVBRjJCM0IsU0FHN0JNLEVBQUE2RCxpQkFINkJ4QyxPQUFBOEIsWUFLdkJNLE9BQUFDLEtBQUFJLFVBTGZDLDRDQXBNUSxNQUFBLDhCQVJaLEdBeU5BQyxFQUFBcEUsUUFBQUksK0JDM0lBZ0UsRUFBQXBFLFFBQUEsQ0FBQXFFLHNCQXJGQSxzQ0NvRUFELEVBQUFwRSxRQXBFQSxTQUFBc0UsR0FBOEMsSUFBQUMsRUFBQWpGLEtBQWRrRixFQUFBLEVBQUEzRixVQUFBa0MsYUFBQTBELElBQUE1RixVQUFBLEdBQUFBLFVBQUEsR0FBaEMsV0FFRTZGLE9BQWNDLFNBQUFDLGNBQWROLFFBQ0FPLFNBQUEsR0FFS3ZGLEtBQUxvRixhQUlBQSxPQUFBSSxhQUFBLGFBQXVDTixFQUF2Q08sWUFDQUwsT0FBQUksYUFBQSxXQUFBLFVBQ0FKLE9BQUFJLGFBQUEsT0FBQSxtQkFDQUosT0FBQU0sVUFBQSwwQ0FHUUMsRUFBT04sU0FBQU8sY0FBYixTQUNBRixVQUFBLHdCQUNBRixhQUFBLE9BQUEsV0FDQUEsYUFBQSxnQkFBQSxLQUNBQSxhQUFBLFdBQUEsS0FDQUQsU0FBQU0sS0FBQUYsS0FDQUcsaUJBQUEsUUFBK0IsU0FBQUMsT0FDdkJDLEVBQW1CZixFQUFBTSxTQUFBbEIsUUFBc0IwQixFQUEvQ0UsVUFDQVYsU0FBQXRCLElBQWtCLFNBQUFpQyxFQUFBL0IsS0FDaEJnQyxVQUFBQyxPQUFBLCtCQUFvRGpDLEdBQXBENkIsR0FDSTdCLElBQUo2QixLQUNFUixhQUFBLGdCQUFBLEtBQ0FBLGFBQUEsV0FBQSxPQUVBQSxhQUFBLGdCQUFBLEtBQ0FBLGFBQUEsWUFBQSxVQUlOSixPQUFBaUIsT0FBQVYsSUFwQkd4QixFQUFMLEVBQWdCQSxHQUFLZSxFQUFyQm9CLElBQUFuQyxJQUF1Q29DLDhCQ2Z6QyxJQUFNekYsRUFBV0YsRUFBakIsY0FDTTRGLEVBQVU1RixFQUFoQixhQXlNUSxJQXhNYUEsRUFBckIsbUJBd01RLENBQVMsaUJBQUEsT0FBbUMsYUFBbEQsSUE5TEY2RixPQUFBQyxRQUFpQixhQUNmM0Isd0JBdUJGLGNBQ000QixLQUFKeEUsa0JBQ1N3RSxLQUFQeEUsZUFFSVIsRUEyS1IsU0FBQW5CLEVBQUFvRyxHQUNFQSxJQUNFQSxFQUFNSCxPQUFBSSxTQUFOQyxRQUNLdEcsRUFBQXVHLFFBQUEsVUFBUCxZQUVFaEQsRUFEWSxJQUFBaUQsT0FBQSxPQUFkeEcsRUFBQSxxQkFDWXlHLEtBRFpMLE9BRUE3QyxTQUNFLFNBR0dBLEVBQUwsU0FDRSxVQUdLbUQsbUJBQW1CbkQsRUFBQSxHQUFBZ0QsUUFBQSxNQUExQixNQXpMV0ksQ0FBWCxVQUNBeEYsV0FHU3lGLG9CQUFBekYsR0FBQVYsS0FBc0MsU0FBQWtCLE9BRTNDQSxRQUNRLElBQUFULE1BQU4sd0JBR0ZTLFVBUkksSUFBQVQsTUFBTiwrQkE1QkZULEtBQThCLFNBQUFrQixRQUM1QkEsV0FBQUEsRUEyQ0osV0FBMEQsSUFBOUJBLEVBQUEsRUFBQTVDLFVBQUFrQyxhQUFBMEQsSUFBQTVGLFVBQUEsR0FBQUEsVUFBQSxHQUFhb0gsS0FBekN4RSxXQUNRM0IsRUFBTzZFLFNBQUFnQyxlQUFiLHFCQUNBQyxVQUFpQm5GLEVBQWpCM0IsT0FDQWdGLGFBQUEsV0FBQSxLQUVnQkgsU0FBQWdDLGVBQWhCLHNCQUNBQyxVQUFvQm5GLEVBQXBCb0YsWUFFTUMsRUFBUW5DLFNBQUFnQyxlQUFkLG9CQUNBM0IsVUFBQSxtQkFDQUYsYUFBQSxNQUFBLGdDQUEwRHJELEVBQTFEM0IsUUFDQWlILElBQVkzRyxFQUFBNEcsc0JBQVp2RixPQUVNcUIsRUFBVTZCLFNBQUFnQyxlQUFoQix3QkFDQTdCLGFBQUEsV0FBQSxPQUNBOEIsVUFBb0JuRixFQUFwQjBCLGFBR0kxQixFQUFKd0YsaUJBVUYsV0FBbUYsSUFBbERDLEVBQUEsRUFBQXJJLFVBQUFrQyxhQUFBMEQsSUFBQTVGLFVBQUEsR0FBQUEsVUFBQSxHQUFpQm9ILEtBQUF4RSxXQUFsRHdGLGdCQUNRRSxFQUFReEMsU0FBQWdDLGVBQWQsd0JBQ0ssSUFBTFMsS0FBQUYsRUFBZ0MsS0FDeEJHLEVBQU0xQyxTQUFBTyxjQUFaLE1BRU1vQyxFQUFNM0MsU0FBQU8sY0FBWixRQUNBMEIsVUFBQVEsSUFDQUcsWUFBQUQsT0FFTUUsRUFBTzdDLFNBQUFPLGNBQWIsUUFDQTBCLFVBQWlCTSxFQUFqQkUsS0FDQXRDLGFBQUEsYUFBZ0NvQyxFQUFBRSxHQVRGLE9BVTlCRyxZQUFBQyxLQUVBRCxZQUFBRixJQXRCREksSUE2QkgsV0FBNEQsSUFBbkMvRixFQUFBLEVBQUE3QyxVQUFBa0MsYUFBQTBELElBQUE1RixVQUFBLEdBQUFBLFVBQUEsR0FBVW9ILEtBQUF4RSxXQUFuQ0MsUUFFUWdHLEVBQVkvQyxTQUFBZ0MsZUFBbEIseUJBRUFqRixFQUFjLEtBQ05pRyxFQUFZaEQsU0FBQU8sY0FBbEIsS0FJRCxTQUhDMEIsVUFBQSxvQkFDQVcsWUFBQUksT0FHSUMsRUFBS2pELFNBQUFnQyxlQUFYLGtCQUNBdkUsUUFBZ0IsU0FBQXlGLEtBQ2ROLFlBUUosU0FBQU0sT0FFUUMsRUFBS25ELFNBQUFPLGNBQVgsUUFDQUosYUFBQSxXQUFBLE9BQ0FFLFVBQUEsc0JBQ0FGLGFBQUEsYUFBQSxjQUVNaUQsRUFBb0JwRCxTQUFBTyxjQUExQixTQUNBRixVQUFBLG9CQUVNZ0QsRUFBbUJyRCxTQUFBTyxjQUF6QixTQUNBRixVQUFBLCtCQUVNbEYsRUFBTzZFLFNBQUFPLGNBQWIsUUFDQUosYUFBQSxXQUFBLE9BQ0FBLGFBQUEsYUFBZ0MrQyxFQUFoQy9ILFFBQ0E4RyxVQUFpQmlCLEVBQWpCL0gsU0FFTW1JLEVBQU90RCxTQUFBTyxjQUFiLFVBQ0FKLGFBQUEsV0FBQSxPQUNBOEIsVUFBaUIsSUFBQXNCLEtBQVNMLEVBQVRNLFdBQWpCQyxpQkFFQWIsWUFBQXpILEtBQ0F5SCxZQUFBVSxLQUVBVixZQUFBUyxLQUVBVCxZQWFGLFNBQUFjLE9BQ1EzRCxFQUFTQyxTQUFBTyxjQUFmLE9BRUFxQyxhQUNNZSxFQUFPM0QsU0FBQU8sY0FBWCxVQUNBRixVQUFBLGtCQUNBRixhQUFBLFdBQUEsT0FDQThCLFVBQWlCLFlBQWpCeUIsRUFDQUMsSUFMa0IsSUFDZEEsTUFPRkMsRUFBYyxJQUFBQyxRQUFsQkgsSUFFSUEsRUFBSixPQUM4QixJQUFBRyxPQUFXLEdBQXZDSCxRQUVJSSxFQUFxQjlELFNBQUFPLGNBQTNCLGlCQUNBRixVQUFBLGlCQUNBNEIsVUFBQTJCLElBQ0FoQixZQUFBa0IsR0FFQS9ELEVBbEM4QmdFLENBQXVCYixFQUFyRG5ELFdBRUE2QyxZQUFBUSxPQUVNWSxFQUFXaEUsU0FBQU8sY0FBakIsY0FDQUosYUFBQSxXQUFBLE9BQ0FFLFVBQUEscUJBQ0E0QixVQUFxQmlCLEVBQXJCYyxXQUNBcEIsWUFBQW9CLEdBRUFiLEVBN0NpQmMsQ0FBZmYsUUFFRk4sWUFBQUssR0F4Q0RpQixHQTlER0MsUUFBQXZGLElBQUEsSUFBZU0sT0FBQUMsS0FBSmlGLElBQW9CcEUsU0FBQWdDLGVBQXBCLE9BQUEsTUFBb0QsVUFFckRsRixFQUZxRHVDLG9CQUEvRCxJQStLSixXQUFvRCxJQUE1QnZDLEVBQUEsRUFBQTVDLFVBQUFrQyxhQUFBMEQsSUFBQTVGLFVBQUEsR0FBQUEsVUFBQSxHQUFXb0gsS0FBbkN4RSxXQUNRdUgsRUFBYXJFLFNBQUFnQyxlQUFuQixjQUNNbUIsRUFBS25ELFNBQUFPLGNBQVgsUUFDQTBCLFVBQWVuRixFQUFmM0IsT0FDQXlILFlBQUFPLEdBNUtFbUIsS0FBQUMsdUJBQWdDakQsS0FBaEN4RSxXQUFpRHdFLEtBQWpEMUMsT0FaRjNDLE1BY1MsU0FBQUMsV0FDUHZDLE1BQUF1QyIsImZpbGUiOiJyZXN0YXVyYW50X2luZm8uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24oKXtmdW5jdGlvbiByKGUsbix0KXtmdW5jdGlvbiBvKGksZil7aWYoIW5baV0pe2lmKCFlW2ldKXt2YXIgYz1cImZ1bmN0aW9uXCI9PXR5cGVvZiByZXF1aXJlJiZyZXF1aXJlO2lmKCFmJiZjKXJldHVybiBjKGksITApO2lmKHUpcmV0dXJuIHUoaSwhMCk7dmFyIGE9bmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbW9kdWxlICdcIitpK1wiJ1wiKTt0aHJvdyBhLmNvZGU9XCJNT0RVTEVfTk9UX0ZPVU5EXCIsYX12YXIgcD1uW2ldPXtleHBvcnRzOnt9fTtlW2ldWzBdLmNhbGwocC5leHBvcnRzLGZ1bmN0aW9uKHIpe3ZhciBuPWVbaV1bMV1bcl07cmV0dXJuIG8obnx8cil9LHAscC5leHBvcnRzLHIsZSxuLHQpfXJldHVybiBuW2ldLmV4cG9ydHN9Zm9yKHZhciB1PVwiZnVuY3Rpb25cIj09dHlwZW9mIHJlcXVpcmUmJnJlcXVpcmUsaT0wO2k8dC5sZW5ndGg7aSsrKW8odFtpXSk7cmV0dXJuIG99cmV0dXJuIHJ9KSgpIiwiJ3VzZSBzdHJpY3QnO1xuXG4oZnVuY3Rpb24oKSB7XG4gIGZ1bmN0aW9uIHRvQXJyYXkoYXJyKSB7XG4gICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFycik7XG4gIH1cblxuICBmdW5jdGlvbiBwcm9taXNpZnlSZXF1ZXN0KHJlcXVlc3QpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXNvbHZlKHJlcXVlc3QucmVzdWx0KTtcbiAgICAgIH07XG5cbiAgICAgIHJlcXVlc3Qub25lcnJvciA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZWplY3QocmVxdWVzdC5lcnJvcik7XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gcHJvbWlzaWZ5UmVxdWVzdENhbGwob2JqLCBtZXRob2QsIGFyZ3MpIHtcbiAgICB2YXIgcmVxdWVzdDtcbiAgICB2YXIgcCA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgcmVxdWVzdCA9IG9ialttZXRob2RdLmFwcGx5KG9iaiwgYXJncyk7XG4gICAgICBwcm9taXNpZnlSZXF1ZXN0KHJlcXVlc3QpLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTtcbiAgICB9KTtcblxuICAgIHAucmVxdWVzdCA9IHJlcXVlc3Q7XG4gICAgcmV0dXJuIHA7XG4gIH1cblxuICBmdW5jdGlvbiBwcm9taXNpZnlDdXJzb3JSZXF1ZXN0Q2FsbChvYmosIG1ldGhvZCwgYXJncykge1xuICAgIHZhciBwID0gcHJvbWlzaWZ5UmVxdWVzdENhbGwob2JqLCBtZXRob2QsIGFyZ3MpO1xuICAgIHJldHVybiBwLnRoZW4oZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIGlmICghdmFsdWUpIHJldHVybjtcbiAgICAgIHJldHVybiBuZXcgQ3Vyc29yKHZhbHVlLCBwLnJlcXVlc3QpO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gcHJveHlQcm9wZXJ0aWVzKFByb3h5Q2xhc3MsIHRhcmdldFByb3AsIHByb3BlcnRpZXMpIHtcbiAgICBwcm9wZXJ0aWVzLmZvckVhY2goZnVuY3Rpb24ocHJvcCkge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFByb3h5Q2xhc3MucHJvdG90eXBlLCBwcm9wLCB7XG4gICAgICAgIGdldDogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXNbdGFyZ2V0UHJvcF1bcHJvcF07XG4gICAgICAgIH0sXG4gICAgICAgIHNldDogZnVuY3Rpb24odmFsKSB7XG4gICAgICAgICAgdGhpc1t0YXJnZXRQcm9wXVtwcm9wXSA9IHZhbDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBwcm94eVJlcXVlc3RNZXRob2RzKFByb3h5Q2xhc3MsIHRhcmdldFByb3AsIENvbnN0cnVjdG9yLCBwcm9wZXJ0aWVzKSB7XG4gICAgcHJvcGVydGllcy5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHtcbiAgICAgIGlmICghKHByb3AgaW4gQ29uc3RydWN0b3IucHJvdG90eXBlKSkgcmV0dXJuO1xuICAgICAgUHJveHlDbGFzcy5wcm90b3R5cGVbcHJvcF0gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHByb21pc2lmeVJlcXVlc3RDYWxsKHRoaXNbdGFyZ2V0UHJvcF0sIHByb3AsIGFyZ3VtZW50cyk7XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gcHJveHlNZXRob2RzKFByb3h5Q2xhc3MsIHRhcmdldFByb3AsIENvbnN0cnVjdG9yLCBwcm9wZXJ0aWVzKSB7XG4gICAgcHJvcGVydGllcy5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHtcbiAgICAgIGlmICghKHByb3AgaW4gQ29uc3RydWN0b3IucHJvdG90eXBlKSkgcmV0dXJuO1xuICAgICAgUHJveHlDbGFzcy5wcm90b3R5cGVbcHJvcF0gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXNbdGFyZ2V0UHJvcF1bcHJvcF0uYXBwbHkodGhpc1t0YXJnZXRQcm9wXSwgYXJndW1lbnRzKTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBwcm94eUN1cnNvclJlcXVlc3RNZXRob2RzKFByb3h5Q2xhc3MsIHRhcmdldFByb3AsIENvbnN0cnVjdG9yLCBwcm9wZXJ0aWVzKSB7XG4gICAgcHJvcGVydGllcy5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHtcbiAgICAgIGlmICghKHByb3AgaW4gQ29uc3RydWN0b3IucHJvdG90eXBlKSkgcmV0dXJuO1xuICAgICAgUHJveHlDbGFzcy5wcm90b3R5cGVbcHJvcF0gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHByb21pc2lmeUN1cnNvclJlcXVlc3RDYWxsKHRoaXNbdGFyZ2V0UHJvcF0sIHByb3AsIGFyZ3VtZW50cyk7XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gSW5kZXgoaW5kZXgpIHtcbiAgICB0aGlzLl9pbmRleCA9IGluZGV4O1xuICB9XG5cbiAgcHJveHlQcm9wZXJ0aWVzKEluZGV4LCAnX2luZGV4JywgW1xuICAgICduYW1lJyxcbiAgICAna2V5UGF0aCcsXG4gICAgJ211bHRpRW50cnknLFxuICAgICd1bmlxdWUnXG4gIF0pO1xuXG4gIHByb3h5UmVxdWVzdE1ldGhvZHMoSW5kZXgsICdfaW5kZXgnLCBJREJJbmRleCwgW1xuICAgICdnZXQnLFxuICAgICdnZXRLZXknLFxuICAgICdnZXRBbGwnLFxuICAgICdnZXRBbGxLZXlzJyxcbiAgICAnY291bnQnXG4gIF0pO1xuXG4gIHByb3h5Q3Vyc29yUmVxdWVzdE1ldGhvZHMoSW5kZXgsICdfaW5kZXgnLCBJREJJbmRleCwgW1xuICAgICdvcGVuQ3Vyc29yJyxcbiAgICAnb3BlbktleUN1cnNvcidcbiAgXSk7XG5cbiAgZnVuY3Rpb24gQ3Vyc29yKGN1cnNvciwgcmVxdWVzdCkge1xuICAgIHRoaXMuX2N1cnNvciA9IGN1cnNvcjtcbiAgICB0aGlzLl9yZXF1ZXN0ID0gcmVxdWVzdDtcbiAgfVxuXG4gIHByb3h5UHJvcGVydGllcyhDdXJzb3IsICdfY3Vyc29yJywgW1xuICAgICdkaXJlY3Rpb24nLFxuICAgICdrZXknLFxuICAgICdwcmltYXJ5S2V5JyxcbiAgICAndmFsdWUnXG4gIF0pO1xuXG4gIHByb3h5UmVxdWVzdE1ldGhvZHMoQ3Vyc29yLCAnX2N1cnNvcicsIElEQkN1cnNvciwgW1xuICAgICd1cGRhdGUnLFxuICAgICdkZWxldGUnXG4gIF0pO1xuXG4gIC8vIHByb3h5ICduZXh0JyBtZXRob2RzXG4gIFsnYWR2YW5jZScsICdjb250aW51ZScsICdjb250aW51ZVByaW1hcnlLZXknXS5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHtcbiAgICBpZiAoIShtZXRob2ROYW1lIGluIElEQkN1cnNvci5wcm90b3R5cGUpKSByZXR1cm47XG4gICAgQ3Vyc29yLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGN1cnNvciA9IHRoaXM7XG4gICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cztcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICBjdXJzb3IuX2N1cnNvclttZXRob2ROYW1lXS5hcHBseShjdXJzb3IuX2N1cnNvciwgYXJncyk7XG4gICAgICAgIHJldHVybiBwcm9taXNpZnlSZXF1ZXN0KGN1cnNvci5fcmVxdWVzdCkudGhlbihmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgICAgIGlmICghdmFsdWUpIHJldHVybjtcbiAgICAgICAgICByZXR1cm4gbmV3IEN1cnNvcih2YWx1ZSwgY3Vyc29yLl9yZXF1ZXN0KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9O1xuICB9KTtcblxuICBmdW5jdGlvbiBPYmplY3RTdG9yZShzdG9yZSkge1xuICAgIHRoaXMuX3N0b3JlID0gc3RvcmU7XG4gIH1cblxuICBPYmplY3RTdG9yZS5wcm90b3R5cGUuY3JlYXRlSW5kZXggPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gbmV3IEluZGV4KHRoaXMuX3N0b3JlLmNyZWF0ZUluZGV4LmFwcGx5KHRoaXMuX3N0b3JlLCBhcmd1bWVudHMpKTtcbiAgfTtcblxuICBPYmplY3RTdG9yZS5wcm90b3R5cGUuaW5kZXggPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gbmV3IEluZGV4KHRoaXMuX3N0b3JlLmluZGV4LmFwcGx5KHRoaXMuX3N0b3JlLCBhcmd1bWVudHMpKTtcbiAgfTtcblxuICBwcm94eVByb3BlcnRpZXMoT2JqZWN0U3RvcmUsICdfc3RvcmUnLCBbXG4gICAgJ25hbWUnLFxuICAgICdrZXlQYXRoJyxcbiAgICAnaW5kZXhOYW1lcycsXG4gICAgJ2F1dG9JbmNyZW1lbnQnXG4gIF0pO1xuXG4gIHByb3h5UmVxdWVzdE1ldGhvZHMoT2JqZWN0U3RvcmUsICdfc3RvcmUnLCBJREJPYmplY3RTdG9yZSwgW1xuICAgICdwdXQnLFxuICAgICdhZGQnLFxuICAgICdkZWxldGUnLFxuICAgICdjbGVhcicsXG4gICAgJ2dldCcsXG4gICAgJ2dldEFsbCcsXG4gICAgJ2dldEtleScsXG4gICAgJ2dldEFsbEtleXMnLFxuICAgICdjb3VudCdcbiAgXSk7XG5cbiAgcHJveHlDdXJzb3JSZXF1ZXN0TWV0aG9kcyhPYmplY3RTdG9yZSwgJ19zdG9yZScsIElEQk9iamVjdFN0b3JlLCBbXG4gICAgJ29wZW5DdXJzb3InLFxuICAgICdvcGVuS2V5Q3Vyc29yJ1xuICBdKTtcblxuICBwcm94eU1ldGhvZHMoT2JqZWN0U3RvcmUsICdfc3RvcmUnLCBJREJPYmplY3RTdG9yZSwgW1xuICAgICdkZWxldGVJbmRleCdcbiAgXSk7XG5cbiAgZnVuY3Rpb24gVHJhbnNhY3Rpb24oaWRiVHJhbnNhY3Rpb24pIHtcbiAgICB0aGlzLl90eCA9IGlkYlRyYW5zYWN0aW9uO1xuICAgIHRoaXMuY29tcGxldGUgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgIGlkYlRyYW5zYWN0aW9uLm9uY29tcGxldGUgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfTtcbiAgICAgIGlkYlRyYW5zYWN0aW9uLm9uZXJyb3IgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmVqZWN0KGlkYlRyYW5zYWN0aW9uLmVycm9yKTtcbiAgICAgIH07XG4gICAgICBpZGJUcmFuc2FjdGlvbi5vbmFib3J0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHJlamVjdChpZGJUcmFuc2FjdGlvbi5lcnJvcik7XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgVHJhbnNhY3Rpb24ucHJvdG90eXBlLm9iamVjdFN0b3JlID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIG5ldyBPYmplY3RTdG9yZSh0aGlzLl90eC5vYmplY3RTdG9yZS5hcHBseSh0aGlzLl90eCwgYXJndW1lbnRzKSk7XG4gIH07XG5cbiAgcHJveHlQcm9wZXJ0aWVzKFRyYW5zYWN0aW9uLCAnX3R4JywgW1xuICAgICdvYmplY3RTdG9yZU5hbWVzJyxcbiAgICAnbW9kZSdcbiAgXSk7XG5cbiAgcHJveHlNZXRob2RzKFRyYW5zYWN0aW9uLCAnX3R4JywgSURCVHJhbnNhY3Rpb24sIFtcbiAgICAnYWJvcnQnXG4gIF0pO1xuXG4gIGZ1bmN0aW9uIFVwZ3JhZGVEQihkYiwgb2xkVmVyc2lvbiwgdHJhbnNhY3Rpb24pIHtcbiAgICB0aGlzLl9kYiA9IGRiO1xuICAgIHRoaXMub2xkVmVyc2lvbiA9IG9sZFZlcnNpb247XG4gICAgdGhpcy50cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbih0cmFuc2FjdGlvbik7XG4gIH1cblxuICBVcGdyYWRlREIucHJvdG90eXBlLmNyZWF0ZU9iamVjdFN0b3JlID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIG5ldyBPYmplY3RTdG9yZSh0aGlzLl9kYi5jcmVhdGVPYmplY3RTdG9yZS5hcHBseSh0aGlzLl9kYiwgYXJndW1lbnRzKSk7XG4gIH07XG5cbiAgcHJveHlQcm9wZXJ0aWVzKFVwZ3JhZGVEQiwgJ19kYicsIFtcbiAgICAnbmFtZScsXG4gICAgJ3ZlcnNpb24nLFxuICAgICdvYmplY3RTdG9yZU5hbWVzJ1xuICBdKTtcblxuICBwcm94eU1ldGhvZHMoVXBncmFkZURCLCAnX2RiJywgSURCRGF0YWJhc2UsIFtcbiAgICAnZGVsZXRlT2JqZWN0U3RvcmUnLFxuICAgICdjbG9zZSdcbiAgXSk7XG5cbiAgZnVuY3Rpb24gREIoZGIpIHtcbiAgICB0aGlzLl9kYiA9IGRiO1xuICB9XG5cbiAgREIucHJvdG90eXBlLnRyYW5zYWN0aW9uID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbih0aGlzLl9kYi50cmFuc2FjdGlvbi5hcHBseSh0aGlzLl9kYiwgYXJndW1lbnRzKSk7XG4gIH07XG5cbiAgcHJveHlQcm9wZXJ0aWVzKERCLCAnX2RiJywgW1xuICAgICduYW1lJyxcbiAgICAndmVyc2lvbicsXG4gICAgJ29iamVjdFN0b3JlTmFtZXMnXG4gIF0pO1xuXG4gIHByb3h5TWV0aG9kcyhEQiwgJ19kYicsIElEQkRhdGFiYXNlLCBbXG4gICAgJ2Nsb3NlJ1xuICBdKTtcblxuICAvLyBBZGQgY3Vyc29yIGl0ZXJhdG9yc1xuICAvLyBUT0RPOiByZW1vdmUgdGhpcyBvbmNlIGJyb3dzZXJzIGRvIHRoZSByaWdodCB0aGluZyB3aXRoIHByb21pc2VzXG4gIFsnb3BlbkN1cnNvcicsICdvcGVuS2V5Q3Vyc29yJ10uZm9yRWFjaChmdW5jdGlvbihmdW5jTmFtZSkge1xuICAgIFtPYmplY3RTdG9yZSwgSW5kZXhdLmZvckVhY2goZnVuY3Rpb24oQ29uc3RydWN0b3IpIHtcbiAgICAgIC8vIERvbid0IGNyZWF0ZSBpdGVyYXRlS2V5Q3Vyc29yIGlmIG9wZW5LZXlDdXJzb3IgZG9lc24ndCBleGlzdC5cbiAgICAgIGlmICghKGZ1bmNOYW1lIGluIENvbnN0cnVjdG9yLnByb3RvdHlwZSkpIHJldHVybjtcblxuICAgICAgQ29uc3RydWN0b3IucHJvdG90eXBlW2Z1bmNOYW1lLnJlcGxhY2UoJ29wZW4nLCAnaXRlcmF0ZScpXSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKTtcbiAgICAgICAgdmFyIGNhbGxiYWNrID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdO1xuICAgICAgICB2YXIgbmF0aXZlT2JqZWN0ID0gdGhpcy5fc3RvcmUgfHwgdGhpcy5faW5kZXg7XG4gICAgICAgIHZhciByZXF1ZXN0ID0gbmF0aXZlT2JqZWN0W2Z1bmNOYW1lXS5hcHBseShuYXRpdmVPYmplY3QsIGFyZ3Muc2xpY2UoMCwgLTEpKTtcbiAgICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICBjYWxsYmFjayhyZXF1ZXN0LnJlc3VsdCk7XG4gICAgICAgIH07XG4gICAgICB9O1xuICAgIH0pO1xuICB9KTtcblxuICAvLyBwb2x5ZmlsbCBnZXRBbGxcbiAgW0luZGV4LCBPYmplY3RTdG9yZV0uZm9yRWFjaChmdW5jdGlvbihDb25zdHJ1Y3Rvcikge1xuICAgIGlmIChDb25zdHJ1Y3Rvci5wcm90b3R5cGUuZ2V0QWxsKSByZXR1cm47XG4gICAgQ29uc3RydWN0b3IucHJvdG90eXBlLmdldEFsbCA9IGZ1bmN0aW9uKHF1ZXJ5LCBjb3VudCkge1xuICAgICAgdmFyIGluc3RhbmNlID0gdGhpcztcbiAgICAgIHZhciBpdGVtcyA9IFtdO1xuXG4gICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkge1xuICAgICAgICBpbnN0YW5jZS5pdGVyYXRlQ3Vyc29yKHF1ZXJ5LCBmdW5jdGlvbihjdXJzb3IpIHtcbiAgICAgICAgICBpZiAoIWN1cnNvcikge1xuICAgICAgICAgICAgcmVzb2x2ZShpdGVtcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGl0ZW1zLnB1c2goY3Vyc29yLnZhbHVlKTtcblxuICAgICAgICAgIGlmIChjb3VudCAhPT0gdW5kZWZpbmVkICYmIGl0ZW1zLmxlbmd0aCA9PSBjb3VudCkge1xuICAgICAgICAgICAgcmVzb2x2ZShpdGVtcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGN1cnNvci5jb250aW51ZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH07XG4gIH0pO1xuXG4gIHZhciBleHAgPSB7XG4gICAgb3BlbjogZnVuY3Rpb24obmFtZSwgdmVyc2lvbiwgdXBncmFkZUNhbGxiYWNrKSB7XG4gICAgICB2YXIgcCA9IHByb21pc2lmeVJlcXVlc3RDYWxsKGluZGV4ZWREQiwgJ29wZW4nLCBbbmFtZSwgdmVyc2lvbl0pO1xuICAgICAgdmFyIHJlcXVlc3QgPSBwLnJlcXVlc3Q7XG5cbiAgICAgIHJlcXVlc3Qub251cGdyYWRlbmVlZGVkID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgICAgICAgaWYgKHVwZ3JhZGVDYWxsYmFjaykge1xuICAgICAgICAgIHVwZ3JhZGVDYWxsYmFjayhuZXcgVXBncmFkZURCKHJlcXVlc3QucmVzdWx0LCBldmVudC5vbGRWZXJzaW9uLCByZXF1ZXN0LnRyYW5zYWN0aW9uKSk7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBwLnRoZW4oZnVuY3Rpb24oZGIpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBEQihkYik7XG4gICAgICB9KTtcbiAgICB9LFxuICAgIGRlbGV0ZTogZnVuY3Rpb24obmFtZSkge1xuICAgICAgcmV0dXJuIHByb21pc2lmeVJlcXVlc3RDYWxsKGluZGV4ZWREQiwgJ2RlbGV0ZURhdGFiYXNlJywgW25hbWVdKTtcbiAgICB9XG4gIH07XG5cbiAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgbW9kdWxlLmV4cG9ydHMgPSBleHA7XG4gICAgbW9kdWxlLmV4cG9ydHMuZGVmYXVsdCA9IG1vZHVsZS5leHBvcnRzO1xuICB9XG4gIGVsc2Uge1xuICAgIHNlbGYuaWRiID0gZXhwO1xuICB9XG59KCkpO1xuIiwiY29uc3QgaWRiID0gcmVxdWlyZSgnaWRiJyk7XHJcbmNvbnN0IEFQUF9EQl9OQU1FID0gJ3Jlc3RhdXJhbnRzLWRiJztcclxuY29uc3QgREJfUkVTVEFVUkFOVFNfVEFCTEUgPSAncmVzdGF1cmFudHMnO1xyXG5jb25zdCBBUFBfREJfVkVSID0gMTtcclxuXHJcbi8qKlxyXG4gKiBDb21tb24gZGF0YWJhc2UgaGVscGVyIGZ1bmN0aW9ucy5cclxuICovXHJcbmNsYXNzIERCSGVscGVyIHtcclxuXHJcbiAgLyoqXHJcbiAgICogRGF0YWJhc2UgVVJMLlxyXG4gICAqIENoYW5nZSB0aGlzIHRvIHJlc3RhdXJhbnRzLmpzb24gZmlsZSBsb2NhdGlvbiBvbiB5b3VyIHNlcnZlci5cclxuICAgKi9cclxuICBzdGF0aWMgZ2V0IERBVEFCQVNFX1VSTCgpIHtcclxuICAgIGNvbnN0IHBvcnQgPSAxMzM3OyAvLyBDaGFuZ2UgdGhpcyB0byB5b3VyIHNlcnZlciBwb3J0XHJcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fWA7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgcmVzdGF1cmFudHMuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudHMoKSB7XHJcbiAgICByZXR1cm4gZmV0Y2goREJIZWxwZXIuREFUQUJBU0VfVVJMICsgJy9yZXN0YXVyYW50cycpXHJcbiAgICAgIC50aGVuKGRhdGEgPT4gZGF0YS5qc29uKCkpXHJcbiAgICAgIC50aGVuKHJlc3RhdXJhbnRzID0+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wdXRSZXN0YXVyYW50c0ludG9JbmRleGVkRGIocmVzdGF1cmFudHMpLnRoZW4oKCkgPT4gcmVzdGF1cmFudHMpO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICByZXR1cm4gREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50c0Zyb21JbmRleGVkRGIoKS50aGVuKHJlc3RhdXJhbnRzID0+IHtcclxuICAgICAgICAgIGlmICghcmVzdGF1cmFudHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmV0Y2ggZXJyb3InKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXN0YXVyYW50cztcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICB9KVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggcmVzdGF1cmFudCBieSBpZCB3aXRoIHJldmlld3MuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudFdpdGhSZXZpZXdzKGlkKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xyXG4gICAgICB0aGlzLmZldGNoUmVzdGF1cmFudChpZCksXHJcbiAgICAgIHRoaXMuZmV0Y2hSZXN0YXVyYW50UmV2aWV3cyhpZClcclxuICAgIF0pLnRoZW4oKFsgcmVzdGF1cmFudCwgcmV2aWV3cyBdKSA9PiB7XHJcbiAgICAgIHJlc3RhdXJhbnQucmV2aWV3cyA9IHJldmlld3M7XHJcbiAgICAgIHJldHVybiB0aGlzLnB1dFJlc3RhdXJhbnRJbnRvSW5kZXhlZERiKHJlc3RhdXJhbnQpLnRoZW4oKCkgPT4gcmVzdGF1cmFudCk7XHJcbiAgICB9KS5jYXRjaChlcnIgPT4ge1xyXG4gICAgICByZXR1cm4gREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50RnJvbUluZGV4ZWREYihpZCkudGhlbihyZXN0YXVyYW50ID0+IHtcclxuICAgICAgICBpZiAoIXJlc3RhdXJhbnQpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmV0Y2ggZXJyb3InKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIHJlc3RhdXJhbnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIHJlc3RhdXJhbnQuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudChpZCkge1xyXG4gICAgcmV0dXJuIGZldGNoKGAke0RCSGVscGVyLkRBVEFCQVNFX1VSTH0vcmVzdGF1cmFudHMvJHtpZH1gKVxyXG4gICAgICAudGhlbihkYXRhID0+IGRhdGEuanNvbigpKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRSZXZpZXdzKHJlc3RhdXJhbnRJZCkge1xyXG4gICAgcmV0dXJuIGZldGNoKGAke0RCSGVscGVyLkRBVEFCQVNFX1VSTH0vcmV2aWV3cy8/cmVzdGF1cmFudF9pZD0ke3Jlc3RhdXJhbnRJZH1gKVxyXG4gICAgICAudGhlbihkYXRhID0+IGRhdGEuanNvbigpKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRzRnJvbUluZGV4ZWREYigpIHtcclxuICAgIHJldHVybiBEQkhlbHBlci5vcGVuRGF0YWJhc2UoKVxyXG4gICAgICAudGhlbihkYiA9PiBkYi50cmFuc2FjdGlvbihEQl9SRVNUQVVSQU5UU19UQUJMRSkub2JqZWN0U3RvcmUoREJfUkVTVEFVUkFOVFNfVEFCTEUpLmdldEFsbCgpKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRGcm9tSW5kZXhlZERiKGlkKSB7XHJcbiAgICByZXR1cm4gREJIZWxwZXIub3BlbkRhdGFiYXNlKCkudGhlbihkYiA9PlxyXG4gICAgICBkYi50cmFuc2FjdGlvbihEQl9SRVNUQVVSQU5UU19UQUJMRSkub2JqZWN0U3RvcmUoREJfUkVTVEFVUkFOVFNfVEFCTEUpLmdldCgraWQpKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBwdXRSZXN0YXVyYW50c0ludG9JbmRleGVkRGIocmVzdGF1cmFudHMpIHtcclxuICAgIHJldHVybiBEQkhlbHBlci5jbGVhclJlc3RhdXJhbnRzSW5JbmRleGVkRGIoKS50aGVuKCgpID0+IERCSGVscGVyLm9wZW5EYXRhYmFzZSgpLnRoZW4oZGIgPT4ge1xyXG4gICAgICAgIGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oREJfUkVTVEFVUkFOVFNfVEFCTEUsICdyZWFkd3JpdGUnKTtcclxuICAgICAgICByZXN0YXVyYW50cy5mb3JFYWNoKHJlc3RhdXJhbnQgPT4gdHgub2JqZWN0U3RvcmUoREJfUkVTVEFVUkFOVFNfVEFCTEUpLnB1dChyZXN0YXVyYW50KSk7XHJcbiAgICAgICAgcmV0dXJuIHR4LmNvbXBsZXRlO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBwdXRSZXN0YXVyYW50SW50b0luZGV4ZWREYihyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gREJIZWxwZXIub3BlbkRhdGFiYXNlKCkudGhlbihkYiA9PiB7XHJcbiAgICAgIGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oREJfUkVTVEFVUkFOVFNfVEFCTEUsICdyZWFkd3JpdGUnKTtcclxuICAgICAgdHgub2JqZWN0U3RvcmUoREJfUkVTVEFVUkFOVFNfVEFCTEUpLnB1dChyZXN0YXVyYW50KTtcclxuICAgICAgcmV0dXJuIHR4LmNvbXBsZXRlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgY2xlYXJSZXN0YXVyYW50c0luSW5kZXhlZERiKCkge1xyXG4gICAgcmV0dXJuIERCSGVscGVyLm9wZW5EYXRhYmFzZSgpLnRoZW4oZGIgPT4ge1xyXG4gICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKERCX1JFU1RBVVJBTlRTX1RBQkxFLCAncmVhZHdyaXRlJyk7XHJcbiAgICAgIHR4Lm9iamVjdFN0b3JlKERCX1JFU1RBVVJBTlRTX1RBQkxFKS5jbGVhcigpO1xyXG4gICAgICByZXR1cm4gdHguY29tcGxldGU7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBvcGVuRGF0YWJhc2UoKSB7XHJcbiAgICByZXR1cm4gaWRiLm9wZW4oQVBQX0RCX05BTUUsIEFQUF9EQl9WRVIsICh1cGdyYWRlRGIpID0+IHtcclxuICAgICAgc3dpdGNoICh1cGdyYWRlRGIub2xkVmVyc2lvbikge1xyXG4gICAgICAgIGNhc2UgMCA6XHJcbiAgICAgICAgICBjb25zdCByZXN0YXVyYW50U3RvcmUgPSB1cGdyYWRlRGIuY3JlYXRlT2JqZWN0U3RvcmUoREJfUkVTVEFVUkFOVFNfVEFCTEUsIHtrZXlQYXRoOiAnaWQnfSk7XHJcbiAgICAgICAgICByZXN0YXVyYW50U3RvcmUuY3JlYXRlSW5kZXgoJ3N0YXR1cycsICdzdGF0dXMnKTtcclxuICAgICAgICAvLyBicmVhayBvbWl0dGVkXHJcbiAgICAgICAgZGVmYXVsdCA6XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGEgcmVzdGF1cmFudCBieSBpdHMgSUQuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5SWQoaWQpIHtcclxuICAgIC8vIGZldGNoIGFsbCByZXN0YXVyYW50cyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgIHJldHVybiBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRXaXRoUmV2aWV3cyhpZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgdHlwZSB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lKGN1aXNpbmUsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHMgIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKCkudGhlbihyZXN0YXVyYW50cyA9PiB7XHJcbiAgICAgIHJldHVybiByZXN0YXVyYW50cy5maWx0ZXIociA9PiByLmN1aXNpbmVfdHlwZSA9PSBjdWlzaW5lKTtcclxuICAgIH0pO1xyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeU5laWdoYm9yaG9vZChuZWlnaGJvcmhvb2QpIHtcclxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xyXG4gICAgcmV0dXJuIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKS50aGVuKHJlc3RhdXJhbnRzID0+IHtcclxuICAgICAgcmV0dXJuIHJlc3RhdXJhbnRzLmZpbHRlcihyID0+IHIubmVpZ2hib3Job29kID09IG5laWdoYm9yaG9vZCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgY3Vpc2luZSBhbmQgYSBuZWlnaGJvcmhvb2Qgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5Q3Vpc2luZUFuZE5laWdoYm9yaG9vZChjdWlzaW5lLCBuZWlnaGJvcmhvb2QpIHtcclxuXHJcbiAgICByZXR1cm4gREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygpLnRoZW4ocmVzdGF1cmFudHMgPT4ge1xyXG4gICAgICBsZXQgcmVzdWx0cyA9IHJlc3RhdXJhbnRzO1xyXG5cclxuICAgICAgaWYgKGN1aXNpbmUgIT0gJ2FsbCcpIHsgLy8gZmlsdGVyIGJ5IGN1aXNpbmVcclxuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLmN1aXNpbmVfdHlwZSA9PSBjdWlzaW5lKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAobmVpZ2hib3Job29kICE9ICdhbGwnKSB7IC8vIGZpbHRlciBieSBuZWlnaGJvcmhvb2RcclxuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLm5laWdoYm9yaG9vZCA9PSBuZWlnaGJvcmhvb2QpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiByZXN1bHRzO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgbmVpZ2hib3Job29kcyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hOZWlnaGJvcmhvb2RzQW5kQ3Vpc2luZXMoKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIHJldHVybiBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKCkudGhlbihyZXN0YXVyYW50cyA9PiB7XHJcbiAgICAgIGNvbnN0IG5laWdoYm9yaG9vZHMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLm5laWdoYm9yaG9vZCk7XHJcbiAgICAgIC8vIEdldCBhbGwgY3Vpc2luZXMgZnJvbSBhbGwgcmVzdGF1cmFudHNcclxuICAgICAgY29uc3QgY3Vpc2luZXMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLmN1aXNpbmVfdHlwZSk7XHJcblxyXG4gICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIG5laWdoYm9yaG9vZHNcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBuZWlnaGJvcmhvb2RzOiBuZWlnaGJvcmhvb2RzLmZpbHRlcigodiwgaSkgPT4gbmVpZ2hib3Job29kcy5pbmRleE9mKHYpID09IGkpLFxyXG4gICAgICAgIGN1aXNpbmVzOiBjdWlzaW5lcy5maWx0ZXIoKHYsIGkpID0+IGN1aXNpbmVzLmluZGV4T2YodikgPT0gaSksXHJcbiAgICAgICAgcmVzdGF1cmFudHMsXHJcbiAgICAgIH07XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgcGFnZSBVUkwuXHJcbiAgICovXHJcbiAgc3RhdGljIHVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkge1xyXG4gICAgcmV0dXJuIChgLi9yZXN0YXVyYW50Lmh0bWw/aWQ9JHtyZXN0YXVyYW50LmlkfWApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBpbWFnZSBVUkwuXHJcbiAgICovXHJcbiAgc3RhdGljIGltYWdlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gYC9pbWcvJHtyZXN0YXVyYW50LmlkfV9zbWFsbC5qcGdgO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBpbWFnZSBVUkwuXHJcbiAgICovXHJcbiAgc3RhdGljIGltYWdlU3JjU2V0Rm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gKGAvaW1nLyR7cmVzdGF1cmFudC5waG90b2dyYXBofWApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTWFwIG1hcmtlciBmb3IgYSByZXN0YXVyYW50LlxyXG4gICAqL1xyXG4gIHN0YXRpYyBtYXBNYXJrZXJGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIG1hcCkge1xyXG4gICAgY29uc3QgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XHJcbiAgICAgICAgcG9zaXRpb246IHJlc3RhdXJhbnQubGF0bG5nLFxyXG4gICAgICAgIHRpdGxlOiByZXN0YXVyYW50Lm5hbWUsXHJcbiAgICAgICAgdXJsOiBEQkhlbHBlci51cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpLFxyXG4gICAgICAgIG1hcDogbWFwLFxyXG4gICAgICAgIGFuaW1hdGlvbjogZ29vZ2xlLm1hcHMuQW5pbWF0aW9uLkRST1BcclxuICAgICAgfVxyXG4gICAgKTtcclxuICAgIHJldHVybiBtYXJrZXI7XHJcbiAgfVxyXG5cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBEQkhlbHBlcjsiLCIvKiBSZWdpc3RlciBzZXJ2aWNlIHdvcmtlciB3aXRoIGV2ZW50cyAqL1xyXG5mdW5jdGlvbiByZWdpc3RlclNlcnZpY2VXb3JrZXIoKSB7XHJcblxyXG4gIHJldHVybjtcclxuXHJcbiAgaWYgKCEnc2VydmljZVdvcmtlcicgaW4gbmF2aWdhdG9yKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NlcnZpY2VXb3JrZXIgbm90IHJlZ2lzdGVyJyk7XHJcbiAgfVxyXG5cclxuICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5yZWdpc3RlcignL3N3LmpzJykudGhlbihmdW5jdGlvbiAocmVnKSB7XHJcbiAgICBpZiAoIW5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLmNvbnRyb2xsZXIpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKHJlZy5hY3RpdmUpIHtcclxuICAgICAgY29uc29sZS5sb2coJ1RoZXJlIGlzIGFuIGFuIGFjdGl2ZSBzZXJ2aWNlIHdvcmtlcicpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChyZWcud2FpdGluZykge1xyXG4gICAgICBjb25zb2xlLmxvZygnd2FpdGluZyA6JywgcmVnLndhaXRpbmcpO1xyXG4gICAgICBjb25zb2xlLmxvZygnc2VydmljZSB3b3JrZXIgaXMgd2FpdGluZycpO1xyXG4gICAgICB1cGRhdGVTZXJ2aWNlV29ya2VyKHJlZy53YWl0aW5nKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAocmVnLmluc3RhbGxpbmcpIHtcclxuICAgICAgY29uc29sZS5sb2coJ2luc3RhbGxpbmcgOiAnLCByZWcpO1xyXG4gICAgICBjb25zb2xlLmxvZygnc2VydmljZSB3b3JrZXIgc3RhdHVzIGlzIGluc3RhbGxpbmcnKTtcclxuICAgICAgdHJhY2tJbnN0YWxsaW5nKHJlZy5pbnN0YWxsaW5nKTtcclxuICAgIH1cclxuXHJcbiAgICByZWcuYWRkRXZlbnRMaXN0ZW5lcigndXBkYXRlZm91bmQnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdzZXJ2aWNlIHdvcmtlciB1cGRhdGUgZm91bmQnLCByZWcpO1xyXG4gICAgICB0cmFja0luc3RhbGxpbmcocmVnLmluc3RhbGxpbmcpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdmFyIHJlZnJlc2hpbmc7XHJcbiAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5hZGRFdmVudExpc3RlbmVyKCdjb250cm9sbGVyY2hhbmdlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICBpZiAocmVmcmVzaGluZykgcmV0dXJuO1xyXG4gICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7XHJcbiAgICAgICAgcmVmcmVzaGluZyA9IHRydWU7XHJcbiAgICAgIH0sIDEwMDApO1xyXG4gICAgfSk7XHJcblxyXG4gIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgY29uc29sZS5sb2coJ1JlZ2lzdHJhdGlvbiBmYWlsZWQgd2l0aCAnICsgZXJyb3IpO1xyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiB0cmFja0luc3RhbGxpbmcoaW5zdGFsbGluZ1dvcmtlcikge1xyXG4gIGlmICghaW5zdGFsbGluZ1dvcmtlcikge1xyXG4gICAgY29uc29sZS5sb2coJ1dvcmtlciBub3QgZGVmaW5lZCEnKTtcclxuICAgIHJldHVybjtcclxuICB9XHJcbiAgaW5zdGFsbGluZ1dvcmtlci5hZGRFdmVudExpc3RlbmVyKCdzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uICgpIHtcclxuICAgIGNvbnNvbGUubG9nKCdTZXJ2aWNlV29ya2VyIHN0YXRlIHdhcyBjaGFuZ2VkIHRvICcgKyBpbnN0YWxsaW5nV29ya2VyLnN0YXRlKTtcclxuICAgIGlmIChpbnN0YWxsaW5nV29ya2VyLnN0YXRlID09PSAnaW5zdGFsbGVkJykge1xyXG4gICAgICBjb25zb2xlLmxvZygnU2VydmljZSB3b3JrZXIgaW5zdGFsbGVkIGFuZCB3YWl0aW5nIGZvciBhY3RpdmF0aW9uJywgaW5zdGFsbGluZ1dvcmtlcik7XHJcbiAgICAgIHVwZGF0ZVNlcnZpY2VXb3JrZXIoaW5zdGFsbGluZ1dvcmtlcik7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZVNlcnZpY2VXb3JrZXIod29ya2VyKSB7XHJcbiAgc2VuZE1lc3NhZ2VUb1NlcnZpY2VXb3JrZXIoe2FjdGlvbjogJ3NraXBXYWl0aW5nJ30sIHdvcmtlcilcclxuICAgIC50aGVuKGZ1bmN0aW9uIChyZXNwb25zZUZyb21Tdykge1xyXG4gICAgICBjb25zb2xlLmxvZyhyZXNwb25zZUZyb21Tdyk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2VuZE1lc3NhZ2VUb1NlcnZpY2VXb3JrZXIobXNnLCB3b3JrZXIpIHtcclxuICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgdmFyIG1zZ0NoYW4gPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTtcclxuXHJcbiAgICAvLyBIYW5kbGVyIGZvciByZWNpZXZpbmcgbWVzc2FnZSByZXBseSBmcm9tIHNlcnZpY2Ugd29ya2VyXHJcbiAgICBtc2dDaGFuLnBvcnQxLm9ubWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICBpZiAoZXZlbnQuZGF0YS5lcnJvcikge1xyXG4gICAgICAgIHJlamVjdChldmVudC5kYXRhLmVycm9yKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXNvbHZlKGV2ZW50LmRhdGEpO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgLy8gU2VuZCBtZXNzYWdlIHRvIHNlcnZpY2Ugd29ya2VyIGFsb25nIHdpdGggcG9ydCBmb3IgcmVwbHlcclxuICAgIHdvcmtlci5wb3N0TWVzc2FnZShtc2csIFttc2dDaGFuLnBvcnQyXSk7XHJcbiAgfSk7XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIHJlZ2lzdGVyU2VydmljZVdvcmtlcixcclxufTsiLCJcbmZ1bmN0aW9uIFJhdGluZ1NlbGVjdChzZWxlY3Rvciwgb3B0aW9ucyA9IHt9KSB7XG5cbiAgdGhpcy5yYXRpbmcgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTtcbiAgdGhpcy5zdGFyTGlzdCA9IFtdO1xuXG4gIGlmICghdGhpcy5yYXRpbmcpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICB0aGlzLnJhdGluZy5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGFiZWwnLCBvcHRpb25zLmxhYmVsKTtcbiAgdGhpcy5yYXRpbmcuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsICcwJyk7XG4gIHRoaXMucmF0aW5nLnNldEF0dHJpYnV0ZSgncm9sZScsICdyYWRpb2dyb3VwJyk7XG4gIHRoaXMucmF0aW5nLmNsYXNzTmFtZSA9ICdyYXRpbmctc2VsZWN0JztcblxuICBmb3IgKGxldCBpID0gMTsgaSA8PSBvcHRpb25zLm1heDsgaSsrKSB7XG4gICAgY29uc3Qgc3RhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIHN0YXIuY2xhc3NOYW1lID0gJ3JhdGluZy1zZWxlY3RfX2l0ZW0nO1xuICAgIHN0YXIuc2V0QXR0cmlidXRlKCdyb2xlJywgJ3JhZGlvJyk7XG4gICAgc3Rhci5zZXRBdHRyaWJ1dGUoJ2FyaWEtY2hlY2tlZCcsIGZhbHNlKTtcbiAgICBzdGFyLnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCAwKTtcbiAgICB0aGlzLnN0YXJMaXN0LnB1c2goc3Rhcik7XG4gICAgc3Rhci5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4ge1xuICAgICAgY29uc3QgY2xpY2tlZFN0YXJJbmRleCA9IHRoaXMuc3Rhckxpc3QuaW5kZXhPZihlLnRhcmdldCk7XG4gICAgICB0aGlzLnN0YXJMaXN0Lm1hcCgoZWwsIGkpID0+IHtcbiAgICAgICAgZWwuY2xhc3NMaXN0LnRvZ2dsZSgncmF0aW5nLXNlbGVjdF9faXRlbS0tY2hlY2tlZCcsIGkgPD0gY2xpY2tlZFN0YXJJbmRleCk7XG4gICAgICAgIGlmIChpID09PSBjbGlja2VkU3RhckluZGV4KSB7XG4gICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCdhcmlhLWNoZWNrZWQnLCB0cnVlKTtcbiAgICAgICAgICBzdGFyLnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCAwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoJ2FyaWEtY2hlY2tlZCcsIGZhbHNlKTtcbiAgICAgICAgICBzdGFyLnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCAtMSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHRoaXMucmF0aW5nLmFwcGVuZChzdGFyKTtcbiAgfVxuXG5cbiAgLypcbiAgPGRpdiByb2xlPVwicmFkaW9ncm91cFwiXG4gICAgIGFyaWEtbGFiZWxsZWRieT1cImdkZXNjMVwiXG4gICAgPlxuICA8aDM+XG4gICAgUGl6emEgQ3J1c3RcbiAgPC9oMz5cbiAgPGRpdiByb2xlPVwicmFkaW9cIlxuICAgICAgIGFyaWEtY2hlY2tlZD1cImZhbHNlXCJcbiAgICAgICB0YWJpbmRleD1cIjBcIj5cbiAgICAgUmVndWxhciBjcnVzdFxuICA8L2Rpdj5cbiAgPGRpdiByb2xlPVwicmFkaW9cIlxuICAgICAgIGFyaWEtY2hlY2tlZD1cImZhbHNlXCJcbiAgICAgICB0YWJpbmRleD1cIi0xXCI+XG4gICAgIERlZXAgZGlzaFxuICA8L2Rpdj5cbiAgPGRpdiByb2xlPVwicmFkaW9cIlxuICAgICAgIGFyaWEtY2hlY2tlZD1cImZhbHNlXCJcbiAgICAgICB0YWJpbmRleD1cIi0xXCI+XG4gICAgIFRoaW4gY3J1c3RcbiAgPC9kaXY+XG48L2Rpdj5cbjxzcGFuIGNsYXNzPVwicmF0aW5nLXN0YXJzXCI+4piGPC9zcGFuPlxuICAgICAgICAgIDxzcGFuIGNsYXNzPVwicmF0aW5nLXN0YXJzXCI+4piFPC9zcGFuPlxuICAqL1xuXG5cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBSYXRpbmdTZWxlY3Q7IiwiY29uc3QgREJIZWxwZXIgPSByZXF1aXJlKCcuL2RiaGVscGVyJyk7XG5jb25zdCBwcm9jZXNzID0gcmVxdWlyZSgnLi9wcm9jZXNzJyk7XG5jb25zdCBSYXRpbmdTZWxlY3QgPSByZXF1aXJlKCcuL3JhdGluZy1zZWxlY3QnKTtcblxubGV0IHJlc3RhdXJhbnQ7XG52YXIgbWFwO1xuXG5jcmVhdGVSYXRpbmdTZWxlY3QoKTtcblxuLyoqXG4gKiBJbml0aWFsaXplIEdvb2dsZSBtYXAsIGNhbGxlZCBmcm9tIEhUTUwuXG4gKi9cbndpbmRvdy5pbml0TWFwID0gKCkgPT4ge1xuICBwcm9jZXNzLnJlZ2lzdGVyU2VydmljZVdvcmtlcigpO1xuICBmZXRjaFJlc3RhdXJhbnRGcm9tVVJMKCkudGhlbihyZXN0YXVyYW50ID0+IHtcbiAgICBzZWxmLnJlc3RhdXJhbnQgPSByZXN0YXVyYW50O1xuXG4gICAgZmlsbFJlc3RhdXJhbnRIVE1MKCk7XG5cbiAgICBzZWxmLm1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLCB7XG4gICAgICB6b29tOiAxNixcbiAgICAgIGNlbnRlcjogcmVzdGF1cmFudC5sYXRsbmcsXG4gICAgICBzY3JvbGx3aGVlbDogZmFsc2VcbiAgICB9KTtcblxuICAgIGZpbGxCcmVhZGNydW1iKCk7XG4gICAgREJIZWxwZXIubWFwTWFya2VyRm9yUmVzdGF1cmFudChzZWxmLnJlc3RhdXJhbnQsIHNlbGYubWFwKTtcblxuICB9KS5jYXRjaChlcnIgPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgfSk7XG59O1xuXG4vKipcbiAqIEdldCBjdXJyZW50IHJlc3RhdXJhbnQgZnJvbSBwYWdlIFVSTC5cbiAqL1xuZnVuY3Rpb24gZmV0Y2hSZXN0YXVyYW50RnJvbVVSTCgpIHtcbiAgaWYgKHNlbGYucmVzdGF1cmFudCkgeyAvLyByZXN0YXVyYW50IGFscmVhZHkgZmV0Y2hlZCFcbiAgICByZXR1cm4gc2VsZi5yZXN0YXVyYW50O1xuICB9XG4gIGNvbnN0IGlkID0gZ2V0UGFyYW1ldGVyQnlOYW1lKCdpZCcpO1xuICBpZiAoIWlkKSB7IC8vIG5vIGlkIGZvdW5kIGluIFVSTFxuICAgIHRocm93IG5ldyBFcnJvcignTm8gcmVzdGF1cmFudCBpZCBpbiBVUkwnKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50QnlJZChpZCkudGhlbigocmVzdGF1cmFudCkgPT4ge1xuXG4gICAgICBpZiAoIXJlc3RhdXJhbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyByZXN0YXVyYW50Jyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXN0YXVyYW50O1xuICAgIH0pO1xuICB9XG59XG5cbi8qKlxuICogQ3JlYXRlIHJlc3RhdXJhbnQgSFRNTCBhbmQgYWRkIGl0IHRvIHRoZSB3ZWJwYWdlXG4gKi9cbmZ1bmN0aW9uIGZpbGxSZXN0YXVyYW50SFRNTChyZXN0YXVyYW50ID0gc2VsZi5yZXN0YXVyYW50KSB7XG4gIGNvbnN0IG5hbWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudC1uYW1lJyk7XG4gIG5hbWUuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5uYW1lO1xuICBuYW1lLnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCAnMCcpO1xuXG4gIGNvbnN0IGFkZHJlc3MgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudC1hZGRyZXNzJyk7XG4gIGFkZHJlc3MuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5hZGRyZXNzO1xuXG4gIGNvbnN0IGltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtaW1nJyk7XG4gIGltYWdlLmNsYXNzTmFtZSA9ICdyZXN0YXVyYW50LWltZyc7XG4gIGltYWdlLnNldEF0dHJpYnV0ZSgnYWx0JywgYEFuIGltYWdlIGZyb20gdGhlIHJlc3RhdXJhbnQgJHtyZXN0YXVyYW50Lm5hbWV9YCk7XG4gIGltYWdlLnNyYyA9IERCSGVscGVyLmltYWdlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KTtcblxuICBjb25zdCBjdWlzaW5lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtY3Vpc2luZScpO1xuICBjdWlzaW5lLnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCAnMCcpO1xuICBjdWlzaW5lLmlubmVySFRNTCA9IHJlc3RhdXJhbnQuY3Vpc2luZV90eXBlO1xuXG4gIC8vIGZpbGwgb3BlcmF0aW5nIGhvdXJzXG4gIGlmIChyZXN0YXVyYW50Lm9wZXJhdGluZ19ob3Vycykge1xuICAgIGZpbGxSZXN0YXVyYW50SG91cnNIVE1MKCk7XG4gIH1cbiAgLy8gZmlsbCByZXZpZXdzXG4gIGZpbGxSZXZpZXdzSFRNTCgpO1xufVxuXG4vKipcbiAqIENyZWF0ZSByZXN0YXVyYW50IG9wZXJhdGluZyBob3VycyBIVE1MIHRhYmxlIGFuZCBhZGQgaXQgdG8gdGhlIHdlYnBhZ2UuXG4gKi9cbmZ1bmN0aW9uIGZpbGxSZXN0YXVyYW50SG91cnNIVE1MKG9wZXJhdGluZ0hvdXJzID0gc2VsZi5yZXN0YXVyYW50Lm9wZXJhdGluZ19ob3Vycykge1xuICBjb25zdCBob3VycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LWhvdXJzJyk7XG4gIGZvciAobGV0IGtleSBpbiBvcGVyYXRpbmdIb3Vycykge1xuICAgIGNvbnN0IHJvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJyk7XG5cbiAgICBjb25zdCBkYXkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZCcpO1xuICAgIGRheS5pbm5lckhUTUwgPSBrZXk7XG4gICAgcm93LmFwcGVuZENoaWxkKGRheSk7XG5cbiAgICBjb25zdCB0aW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKTtcbiAgICB0aW1lLmlubmVySFRNTCA9IG9wZXJhdGluZ0hvdXJzW2tleV07XG4gICAgdGltZS5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGFiZWwnLCBvcGVyYXRpbmdIb3Vyc1trZXldICsgJywnKTsgLy8gZm9yIHNjcmVlbiByZWFkZXJcbiAgICByb3cuYXBwZW5kQ2hpbGQodGltZSk7XG5cbiAgICBob3Vycy5hcHBlbmRDaGlsZChyb3cpO1xuICB9XG59XG5cbi8qKlxuICogQ3JlYXRlIGFsbCByZXZpZXdzIEhUTUwgYW5kIGFkZCB0aGVtIHRvIHRoZSB3ZWJwYWdlLlxuICovXG5mdW5jdGlvbiBmaWxsUmV2aWV3c0hUTUwocmV2aWV3cyA9IHNlbGYucmVzdGF1cmFudC5yZXZpZXdzKSB7XG5cbiAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlld3MtY29udGFpbmVyJyk7XG5cbiAgaWYgKCFyZXZpZXdzKSB7XG4gICAgY29uc3Qgbm9SZXZpZXdzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xuICAgIG5vUmV2aWV3cy5pbm5lckhUTUwgPSAnTm8gcmV2aWV3cyB5ZXQhJztcbiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQobm9SZXZpZXdzKTtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmV2aWV3cy1saXN0Jyk7XG4gIHJldmlld3MuZm9yRWFjaChyZXZpZXcgPT4ge1xuICAgIHVsLmFwcGVuZENoaWxkKGNyZWF0ZVJldmlld0hUTUwocmV2aWV3KSk7XG4gIH0pO1xuICBjb250YWluZXIuYXBwZW5kQ2hpbGQodWwpO1xufVxuXG4vKipcbiAqIENyZWF0ZSByZXZpZXcgSFRNTCBhbmQgYWRkIGl0IHRvIHRoZSB3ZWJwYWdlLlxuICovXG5mdW5jdGlvbiBjcmVhdGVSZXZpZXdIVE1MKHJldmlldykge1xuXG4gIGNvbnN0IGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcbiAgbGkuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsICcwJyk7XG4gIGxpLmNsYXNzTmFtZSA9ICdyZXZpZXdzLWxpc3QtaXRlbSc7XG4gIGxpLnNldEF0dHJpYnV0ZSgnYXJpYS1sYWJlbCcsICdyZXZpZXcnKTtcblxuICBjb25zdCByZXZpZXdlckluZm9CbG9jayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICByZXZpZXdlckluZm9CbG9jay5jbGFzc05hbWUgPSAncmV2aWV3ZXItaW5mbyc7XG5cbiAgY29uc3QgcmV2aWV3ZXJOYW1lRGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICByZXZpZXdlck5hbWVEYXRlLmNsYXNzTmFtZSA9ICdyZXZpZXdlci1pbmZvX19uYW1lLWRhdGUnO1xuXG4gIGNvbnN0IG5hbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdoMycpO1xuICBuYW1lLnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCAnMCcpO1xuICBuYW1lLnNldEF0dHJpYnV0ZSgnYXJpYS1sYWJlbCcsIHJldmlldy5uYW1lKTtcbiAgbmFtZS5pbm5lckhUTUwgPSByZXZpZXcubmFtZTtcblxuICBjb25zdCBkYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGF0ZScpO1xuICBkYXRlLnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCAnMCcpO1xuICBkYXRlLmlubmVySFRNTCA9IG5ldyBEYXRlKHJldmlldy51cGRhdGVkQXQpLnRvRGF0ZVN0cmluZygpO1xuXG4gIHJldmlld2VyTmFtZURhdGUuYXBwZW5kQ2hpbGQobmFtZSk7XG4gIHJldmlld2VyTmFtZURhdGUuYXBwZW5kQ2hpbGQoZGF0ZSk7XG5cbiAgcmV2aWV3ZXJJbmZvQmxvY2suYXBwZW5kQ2hpbGQocmV2aWV3ZXJOYW1lRGF0ZSk7XG5cbiAgcmV2aWV3ZXJJbmZvQmxvY2suYXBwZW5kQ2hpbGQoY3JlYXRlUmF0aW5nU3RhcnNCbG9jayhyZXZpZXcucmF0aW5nKSk7XG5cbiAgbGkuYXBwZW5kQ2hpbGQocmV2aWV3ZXJJbmZvQmxvY2spO1xuXG4gIGNvbnN0IGNvbW1lbnRzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xuICBjb21tZW50cy5zZXRBdHRyaWJ1dGUoJ3RhYmluZGV4JywgJzAnKTtcbiAgY29tbWVudHMuY2xhc3NOYW1lID0gJ3Jldmlld2VyLWNvbW1lbnQnO1xuICBjb21tZW50cy5pbm5lckhUTUwgPSByZXZpZXcuY29tbWVudHM7XG4gIGxpLmFwcGVuZENoaWxkKGNvbW1lbnRzKTtcblxuICByZXR1cm4gbGk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVJhdGluZ1N0YXJzQmxvY2socmF0aW5nVmFsdWUpIHtcbiAgY29uc3QgcmF0aW5nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xuXG4gIHJhdGluZy5hcHBlbmRDaGlsZCgoKCkgPT4ge1xuICAgIGxldCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgIHNwYW4uY2xhc3NOYW1lID0gJ3JhdGluZy1udW1iZXInO1xuICAgIHNwYW4uc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsICcwJyk7XG4gICAgc3Bhbi5pbm5lckhUTUwgPSAnUmF0aW5nIDogJyArIHJhdGluZ1ZhbHVlO1xuICAgIHJldHVybiBzcGFuO1xuICB9KSgpKTtcblxuICBsZXQgcmF0aW5nU3RhcnMgPSAn4piFJy5yZXBlYXQoK3JhdGluZ1ZhbHVlKTtcblxuICBpZiAoK3JhdGluZ1ZhbHVlIDwgNSkge1xuICAgIHJhdGluZ1N0YXJzID0gcmF0aW5nU3RhcnMgKyAn4piGJy5yZXBlYXQoNSAtICtyYXRpbmdWYWx1ZSk7XG4gIH1cbiAgY29uc3QgcmF0aW5nU3RhcnNFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICByYXRpbmdTdGFyc0VsZW1lbnQuY2xhc3NOYW1lID0gJ3JhdGluZy1zdGFycyc7XG4gIHJhdGluZ1N0YXJzRWxlbWVudC5pbm5lckhUTUwgPSByYXRpbmdTdGFycztcbiAgcmF0aW5nLmFwcGVuZENoaWxkKHJhdGluZ1N0YXJzRWxlbWVudCk7XG5cbiAgcmV0dXJuIHJhdGluZztcbn1cblxuLyoqXG4gKiBBZGQgcmVzdGF1cmFudCBuYW1lIHRvIHRoZSBicmVhZGNydW1iIG5hdmlnYXRpb24gbWVudVxuICovXG5mdW5jdGlvbiBmaWxsQnJlYWRjcnVtYihyZXN0YXVyYW50PXNlbGYucmVzdGF1cmFudCkge1xuICBjb25zdCBicmVhZGNydW1iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2JyZWFkY3J1bWInKTtcbiAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xuICBsaS5pbm5lckhUTUwgPSByZXN0YXVyYW50Lm5hbWU7XG4gIGJyZWFkY3J1bWIuYXBwZW5kQ2hpbGQobGkpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVSYXRpbmdTZWxlY3QoKSB7XG4gIGNvbnN0IHNlbGVjdCA9IG5ldyBSYXRpbmdTZWxlY3QoJyNyYXRpbmctc2VsZWN0Jywge1xuICAgIGxhYmVsOiAnUmF0aW5nJyxcbiAgICBtYXg6IDUsXG4gIH0pO1xufVxuXG4vKipcbiAqIEdldCBhIHBhcmFtZXRlciBieSBuYW1lIGZyb20gcGFnZSBVUkwuXG4gKi9cbmZ1bmN0aW9uIGdldFBhcmFtZXRlckJ5TmFtZSAobmFtZSwgdXJsKSB7XG4gIGlmICghdXJsKVxuICAgIHVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmO1xuICBuYW1lID0gbmFtZS5yZXBsYWNlKC9bXFxbXFxdXS9nLCAnXFxcXCQmJyk7XG4gIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChgWz8mXSR7bmFtZX0oPShbXiYjXSopfCZ8I3wkKWApLFxuICAgIHJlc3VsdHMgPSByZWdleC5leGVjKHVybCk7XG4gIGlmICghcmVzdWx0cykge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgaWYgKCFyZXN1bHRzWzJdKSB7XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChyZXN1bHRzWzJdLnJlcGxhY2UoL1xcKy9nLCAnICcpKTtcbn1cbiJdfQ==
